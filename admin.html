<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–¶–ù–ê–ü Admin ‚Äî –ü–∞–Ω–µ–ª—å</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#eef6ff;
    --card:#ffffff;
    --accent:#0052cc;
    --muted:#6b7280;
    --radius:14px;
    --glass: rgba(255,255,255,0.7);
  }
  *{box-sizing:border-box}
  body{font-family:"Inter",system-ui,Arial;background:linear-gradient(180deg,#f3f8ff 0%,#f8fbff 100%);margin:0;color:#0f172a}
  header{position:sticky;top:0;background:var(--glass);backdrop-filter:blur(8px);border-bottom:1px solid rgba(15,23,42,0.06);padding:14px 6%;display:flex;justify-content:space-between;align-items:center;z-index:40}
  .brand{font-weight:800;color:var(--accent)}
  .nav-actions{display:flex;gap:12px;align-items:center}
  .nav-actions a{color:#0f172a;text-decoration:none;font-weight:600;opacity:0.9}

  .layout{display:flex;min-height:calc(100vh - 64px)}
  aside{width:300px;padding:28px;background:linear-gradient(180deg,rgba(255,255,255,0.85),rgba(255,255,255,0.8));border-right:1px solid rgba(2,6,23,0.04)}
  aside h2{margin:0;color:var(--accent);font-size:1.1rem;font-weight:800}
  .menu{margin-top:20px;display:flex;flex-direction:column;gap:8px}
  .menu button{background:none;border:0;padding:12px;border-radius:10px;text-align:left;cursor:pointer;font-weight:700;opacity:0.85}
  .menu button.active{background:var(--accent);color:white;box-shadow:0 8px 24px rgba(0,82,204,0.12)}

  main{flex:1;padding:36px;overflow:auto}
  .card{background:var(--card);border-radius:12px;padding:20px;border:1px solid rgba(2,6,23,0.04);box-shadow:0 14px 40px rgba(2,6,23,0.06);max-width:1100px}
  h3{margin-top:0;color:var(--accent)}

  .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .full{grid-column:span 2}
  label{display:block;font-weight:600;margin-bottom:6px}
  input,textarea,select{width:100%;padding:10px;border-radius:10px;border:1px solid #eef2ff;background:#fbfdff;font-family:inherit}
  textarea{min-height:100px}

  .upload{border:2px dashed #e6eefc;border-radius:10px;padding:10px;text-align:center;cursor:pointer}
  #thumb{max-width:160px;border-radius:8px;display:none;margin-top:8px}

  /* canvas sign */
  .sig-wrap{border:1px solid #eef2ff;border-radius:10px;overflow:hidden}
  canvas{width:100%;height:160px;touch-action:none;display:block}

  .btn{background:var(--accent);color:white;padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:800}
  .btn-ghost{background:#f3f6ff;color:var(--accent);border:1px solid rgba(0,82,204,0.08);padding:8px 12px;border-radius:8px;cursor:pointer}
  .row{display:flex;justify-content:space-between;align-items:center}

  /* requests carousel */
  .requests-row{display:flex;gap:12px;overflow-x:auto;padding:12px 6px}
  .req-card{min-width:240px;background:linear-gradient(180deg,#fff,#fbfdff);padding:12px;border-radius:12px;border:1px solid rgba(2,6,23,0.04);box-shadow:0 8px 30px rgba(2,6,23,0.04);display:flex;flex-direction:column;gap:8px}
  .req-title{font-weight:800}
  .req-meta{font-size:0.9rem;color:var(--muted)}

  /* lists */
  .list{margin-top:12px;border-top:1px solid #f1f5f9}
  .list .item{display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid #f8fbff}

  .small{font-size:0.9rem;color:var(--muted)}

  @media (max-width:900px){
    aside{display:none} main{padding:18px}
  }
</style>
</head>
<body>

<header>
  <div class="brand">–¶–ù–ê–ü ADMIN</div>
  <div class="nav-actions">
    <span class="small">–í–∞—à –∞–∫–∞—É–Ω—Ç: <b id="admin-name">Admin</b></span>
    <a href="index.html" class="small" style="margin-left:12px">–ù–∞ —Å–∞–π—Ç</a>
  </div>
</header>

<div class="layout">
  <aside>
    <h2>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è</h2>
    <div class="menu" role="navigation" aria-label="admin-menu">
      <button class="active" onclick="openTab('issue', this)">üìÑ –í–∏–¥–∞—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç</button>
      <button onclick="openTab('requests', this)">üìù –ó–∞—è–≤–∫–∏</button>
      <button onclick="openTab('users', this)">üë• –ì—Ä–æ–º–∞–¥—è–Ω–∏</button>
      <button onclick="openTab('logs', this)">üìú –ñ—É—Ä–Ω–∞–ª</button>
      <button onclick="openTab('deletes', this)">‚ùå –ó–∞–ø–∏—Ç–∏ –Ω–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è</button>
    </div>
    <div style="margin-top:20px" class="small">–ü–∞–º'—è—Ç–∞–π: –ø–æ—Ä–æ–∂–Ω—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏ –≤–∏–¥–∞–ª—è—é—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ.</div>
  </aside>

  <main>
    <!-- ISSUE -->
    <section id="issue" class="card" style="display:block">
      <h3>–í–∏–¥–∞—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç</h3>
      <div class="form-grid">
        <div>
          <label>ID –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (UA-...)</label>
          <input id="targetId" placeholder="–ù–∞–ø—Ä. UA-5640-45-874">
        </div>
        <div>
          <label>–¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞</label>
          <input id="docType" placeholder="–ü–∞—Å–ø–æ—Ä—Ç, –í–∏—Ç—è–≥...">
        </div>

        <div>
          <label>–î–∂–µ—Ä–µ–ª–æ (source)</label>
          <input id="docSource" placeholder="–í—ñ–π—Å—å–∫–∫–æ–º–∞—Ç, –õ—ñ–∫–∞—Ä–Ω—è...">
        </div>
        <div>
          <label>–ü–µ—á–∞—Ç–∫–∞</label>
          <select id="stampType">
            <option value="circle">–ö—Ä—É–≥–ª–∞</option>
            <option value="square">–ö–≤–∞–¥—Ä–∞—Ç–Ω–∞</option>
            <option value="none">–ë–µ–∑ –ø–µ—á–∞—Ç–∫–∏</option>
          </select>
        </div>

        <div class="full">
          <label>–¢–µ—Ä–º—ñ–Ω –¥—ñ–π—Å–Ω–æ—Å—Ç—ñ (validUntil)</label>
          <input id="validUntil" type="date">
        </div>

        <div class="full">
          <label>–§–æ—Ç–æ (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</label>
          <div class="upload" onclick="document.getElementById('file').click()">–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –¥–ª—è –≤–∏–±–æ—Ä—É –∫–∞—Ä—Ç–∏–Ω–∫–∏
            <input id="file" type="file" accept="image/*" style="display:none" onchange="onFile(event)">
          </div>
          <img id="thumb" alt="preview">
        </div>

        <div class="full">
          <label>–û–ø–∏—Å / –¢–µ–∫—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞</label>
          <textarea id="docDesc" placeholder="–î–µ—Ç–∞–ª—ñ, —Å–µ—Ä—ñ—è/–Ω–æ–º–µ—Ä, —ñ–Ω—à–µ..."></textarea>
        </div>

        <div class="full">
          <label>–ü—ñ–¥–ø–∏—Å —Ä–µ—î—Å—Ç—Ä–∞—Ç–æ—Ä–∞</label>
          <div class="sig-wrap">
            <canvas id="sigCanvas"></canvas>
            <div style="padding:8px;text-align:right;background:#fafcff">
              <button class="btn-ghost" onclick="clearSignature()">–û—á–∏—Å—Ç–∏—Ç–∏ –ø—ñ–¥–ø–∏—Å</button>
            </div>
          </div>
        </div>

        <div class="full" style="display:flex;gap:12px;align-items:center">
          <button class="btn" onclick="issueFromForm()">–ó–∞—Ç–≤–µ—Ä–¥–∏—Ç–∏ —Ç–∞ –≤–∏–¥–∞—Ç–∏</button>
          <button class="btn-ghost" onclick="prefillFromCurrentDoc()">–ó–∞–ø–æ–≤–Ω–∏—Ç–∏ –∑ –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ</button>
          <div style="margin-left:auto" id="issue-hint" class="small"></div>
        </div>
      </div>
    </section>

    <!-- REQUESTS -->
    <section id="requests" class="card" style="display:none;margin-top:18px">
      <h3>–ó–∞—è–≤–∫–∏ –≤—ñ–¥ –≥—Ä–æ–º–∞–¥—è–Ω</h3>
      <div class="small">–ù–∞—Ç–∏—Å–Ω–∏ "–°—Ç–≤–æ—Ä–∏—Ç–∏" —â–æ–± –≤—ñ–¥–∫—Ä–∏—Ç–∏ —Ñ–æ—Ä–º—É –≤–∏–¥–∞—á—ñ –∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–º–∏ –ø–æ–ª—è–º–∏.</div>
      <div class="requests-row" id="requestsRow" style="margin-top:12px"></div>

      <div style="margin-top:16px" class="small">–ö–æ–∂–Ω—É –∑–∞—è–≤–∫—É –º–æ–∂–Ω–∞ –≤–∏–¥–∞–ª–∏—Ç–∏ –∞–±–æ –ø—Ä–∏–π–Ω—è—Ç–∏.</div>
    </section>

    <!-- USERS -->
    <section id="users" class="card" style="display:none;margin-top:18px">
      <h3>–ì—Ä–æ–º–∞–¥—è–Ω–∏ –≤ –±–∞–∑—ñ</h3>
      <div id="usersList" class="list"></div>
    </section>

    <!-- LOGS -->
    <section id="logs" class="card" style="display:none;margin-top:18px">
      <h3>–ñ—É—Ä–Ω–∞–ª –¥—ñ–π</h3>
      <div id="logsList" class="list"></div>
    </section>

    <!-- DELETES -->
    <section id="deletes" class="card" style="display:none;margin-top:18px">
      <h3>–ó–∞–ø–∏—Ç–∏ –Ω–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è</h3>
      <div id="deletesList" class="list"></div>
    </section>
  </main>
</div>

<script>
/* ---------- CONFIG KEYS ---------- */
const DB_KEY = 'gov_documents';
const APPLY_KEY = 'apply_requests';
const DELETE_KEY = 'delete_requests';
const LOGS_KEY = 'gov_logs';

/* ---------- ROLE CHECK ---------- */
if(localStorage.getItem('userRole') !== 'highadmin') {
  // redirect to index if not admin
  // but for convenience in dev you can comment next line
  // window.location.href = 'index.html';
}

/* ---------- UI helpers ---------- */
function openTab(id, btn){
  document.querySelectorAll('main > section').forEach(s => s.style.display = 'none');
  document.getElementById(id).style.display = 'block';
  document.querySelectorAll('aside .menu button').forEach(b => b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  // refresh content for tab
  if(id === 'requests') renderRequests();
  if(id === 'users') renderUsers();
  if(id === 'logs') renderLogs();
  if(id === 'deletes') renderDeletes();
}

/* ---------- Cleanup empty documents (global) ---------- */
function cleanupEmptyDocumentsSave(){
  const db = JSON.parse(localStorage.getItem(DB_KEY)) || {};
  let changed = false;
  for(const uid of Object.keys(db)){
    const before = db[uid];
    const after = before.filter(d => {
      const t = (d.type && d.type.toString().trim().length);
      const desc = d.desc && d.desc.toString().trim().length;
      const img = !!d.img;
      const sig = d.signature && d.signature.length > 60;
      // keep if any content exists
      return (t || desc || img || sig);
    });
    if(after.length !== before.length){
      if(after.length === 0) delete db[uid];
      else db[uid] = after;
      changed = true;
    }
  }
  if(changed) localStorage.setItem(DB_KEY, JSON.stringify(db));
  return db;
}

/* ---------- Signature Canvas ---------- */
const sigCanvas = document.getElementById('sigCanvas');
const sctx = sigCanvas.getContext('2d');
let drawing=false;
function resizeSig(){ sigCanvas.width = sigCanvas.clientWidth; sigCanvas.height = sigCanvas.clientHeight; sctx.strokeStyle="#002752"; sctx.lineWidth=3; sctx.lineCap='round'; }
window.addEventListener('resize', resizeSig);
resizeSig();

sigCanvas.addEventListener('pointerdown', e => { drawing=true; const r = sigCanvas.getBoundingClientRect(); sctx.beginPath(); sctx.moveTo(e.clientX - r.left, e.clientY - r.top); });
sigCanvas.addEventListener('pointermove', e => { if(!drawing) return; const r = sigCanvas.getBoundingClientRect(); sctx.lineTo(e.clientX - r.left, e.clientY - r.top); sctx.stroke(); });
window.addEventListener('pointerup', () => drawing=false);
function clearSignature(){ sctx.clearRect(0,0,sigCanvas.width,sigCanvas.height); }

/* ---------- Image upload ---------- */
let chosenImg = null;
function onFile(e){
  const f = e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = () => {
    chosenImg = reader.result;
    const t = document.getElementById('thumb'); t.src = chosenImg; t.style.display='block';
  };
  reader.readAsDataURL(f);
}

/* ---------- Requests rendering ---------- */
function renderRequests(){
  // cleanup empty docs first (safety)
  cleanupEmptyDocumentsSave();

  const row = document.getElementById('requestsRow');
  row.innerHTML = '';
  const requests = JSON.parse(localStorage.getItem(APPLY_KEY) || '[]');
  if(requests.length === 0){ row.innerHTML = '<div class="small">–ù–µ–º–∞—î –Ω–æ–≤–∏—Ö –∑–∞—è–≤–æ–∫</div>'; return; }

  requests.forEach((r, idx) => {
    const c = document.createElement('div'); c.className = 'req-card';
    c.innerHTML = `
      <div class="req-title">${escapeHtml(r.title)}</div>
      <div class="req-meta"><span><b>–í—ñ–¥:</b> ${escapeHtml(r.source)}</span><span><b>–î—ñ–π—Å–Ω–∏–π –¥–æ:</b> ${escapeHtml(r.validUntil)}</span><span class="small">${escapeHtml(r.dateSent || '')}</span></div>
      <div style="display:flex;gap:8px;margin-top:6px">
        <button class="btn" onclick="createFromRequest(${idx})">–°—Ç–≤–æ—Ä–∏—Ç–∏</button>
        <button class="btn-ghost" onclick="previewRequest(${idx})">–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏</button>
        <button class="btn-ghost" style="background:#fff;color:#ef4444;border:1px solid rgba(239,68,68,0.08)" onclick="removeRequest(${idx})">–í–∏–¥–∞–ª–∏—Ç–∏</button>
      </div>
    `;
    row.appendChild(c);
  });
}

/* preview request (simple modal-like) */
function previewRequest(i){
  const requests = JSON.parse(localStorage.getItem(APPLY_KEY) || '[]');
  const r = requests[i];
  if(!r) return alert('–ó–∞—è–≤–∫–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞');
  const txt = `–ó–∞—è–≤–∫–∞: ${r.title}\n–í—ñ–¥: ${r.source}\n–î—ñ–π—Å–Ω–∏–π –¥–æ: ${r.validUntil}\n–û–ø–∏—Å: ${r.desc || '(–ø–æ—Ä–æ–∂–Ω—å–æ)'}\nID: ${r.id}`;
  alert(txt);
}

/* remove request */
function removeRequest(i){
  if(!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü—é –∑–∞—è–≤–∫—É?')) return;
  const reqs = JSON.parse(localStorage.getItem(APPLY_KEY) || '[]');
  reqs.splice(i,1);
  localStorage.setItem(APPLY_KEY, JSON.stringify(reqs));
  renderRequests();
}

/* create document from request => prefill issue form, switch tab */
function createFromRequest(i){
  const reqs = JSON.parse(localStorage.getItem(APPLY_KEY) || '[]');
  const r = reqs[i];
  if(!r) return alert('–ü–æ–º–∏–ª–∫–∞: –∑–∞—è–≤–∫–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞');

  // prefill
  document.getElementById('targetId').value = r.id;
  document.getElementById('docType').value = r.title;
  document.getElementById('docSource').value = r.source || '';
  document.getElementById('validUntil').value = r.validUntil || '';
  document.getElementById('docDesc').value = r.desc || '';
  document.getElementById('stampType').value = r.stamp || 'circle';
  // show image if any
  if(r.img){ chosenImg = r.img; const t = document.getElementById('thumb'); t.src = chosenImg; t.style.display='block'; }
  else { chosenImg = null; document.getElementById('thumb').style.display='none'; }
  // clear signature for admin to sign
  clearSignature();
  // switch to issue tab
  openTab('issue', document.querySelector('.menu button'));
  // optionally remove request (we leave it so admin can remove manually after issue)
}

/* ---------- Users list ---------- */
function renderUsers(){
  const db = cleanupEmptyDocumentsSave();
  const box = document.getElementById('usersList');
  box.innerHTML = '';
  const uids = Object.keys(db).sort();
  if(uids.length === 0) { box.innerHTML = '<div class="item">–ù–µ–º–∞—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤</div>'; return; }
  uids.forEach(uid => {
    const row = document.createElement('div'); row.className='item';
    row.innerHTML = `<div><b>${uid}</b> <div class="small">${(db[uid][0].source || '‚Äî')}</div></div><div>${db[uid].length} –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤ <button class="btn-ghost" style="margin-left:8px" onclick="viewUser('${uid}')">–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏</button></div>`;
    box.appendChild(row);
  });
}
function viewUser(uid){
  // quick view: list docs
  const db = JSON.parse(localStorage.getItem(DB_KEY)) || {};
  const arr = db[uid] || [];
  if(arr.length === 0) return alert('–î–æ–∫—É–º–µ–Ω—Ç—ñ–≤ –Ω–µ–º–∞—î');
  const list = arr.map(d => `${d.docId} ‚Äî ${d.type} (–¥–æ ${d.validUntil || '‚Äî'})`).join('\n');
  alert(`–î–æ–∫—É–º–µ–Ω—Ç–∏ ${uid}:\n\n${list}`);
}

/* ---------- Logs ---------- */
function renderLogs(){
  const logs = JSON.parse(localStorage.getItem(LOGS_KEY) || '[]');
  const box = document.getElementById('logsList');
  box.innerHTML = '';
  if(logs.length === 0) { box.innerHTML = '<div class="item">–ñ—É—Ä–Ω–∞–ª –ø–æ—Ä–æ–∂–Ω—ñ–π</div>'; return; }
  logs.forEach(l => {
    const it = document.createElement('div'); it.className='item'; it.textContent = l;
    box.appendChild(it);
  });
}

/* ---------- Deletes (requests on deletion) ---------- */
function renderDeletes(){
  const arr = JSON.parse(localStorage.getItem(DELETE_KEY) || '[]');
  const box = document.getElementById('deletesList');
  box.innerHTML = '';
  if(arr.length === 0){ box.innerHTML = '<div class="item">–ù–µ–º–∞—î –∑–∞–ø–∏—Ç—ñ–≤ –Ω–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è</div>'; return; }
  arr.forEach((r, idx) => {
    const it = document.createElement('div'); it.className='item';
    const left = document.createElement('div'); left.innerHTML = `<b>${r.docId}</b> ‚Äî ${r.uid} <div class="small">${r.date}</div>`;
    const right = document.createElement('div');
    const ok = document.createElement('button'); ok.className='btn'; ok.textContent='–ü—Ä–∏–π–Ω—è—Ç–∏'; ok.onclick = ()=>processDelete(idx, true);
    const no = document.createElement('button'); no.className='btn-ghost'; no.textContent='–í—ñ–¥—Ö–∏–ª–∏—Ç–∏'; no.onclick = ()=>processDelete(idx, false);
    right.appendChild(ok); right.appendChild(no);
    it.appendChild(left); it.appendChild(right);
    box.appendChild(it);
  });
}
function processDelete(index, approve){
  const arr = JSON.parse(localStorage.getItem(DELETE_KEY) || '[]');
  const req = arr[index];
  if(!req) return;
  if(approve){
    const db = JSON.parse(localStorage.getItem(DB_KEY)) || {};
    if(db[req.uid]){
      db[req.uid] = db[req.uid].filter(d => d.docId !== req.docId);
      if(db[req.uid].length === 0) delete db[req.uid];
      localStorage.setItem(DB_KEY, JSON.stringify(db));
      pushLog(`–ê–¥–º—ñ–Ω –≤–∏–¥–∞–ª–∏–≤ –¥–æ–∫—É–º–µ–Ω—Ç ${req.docId} –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ ${req.uid}`);
    }
  } else {
    pushLog(`–ê–¥–º—ñ–Ω –≤—ñ–¥—Ö–∏–ª–∏–≤ –∑–∞–ø–∏—Ç –Ω–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è ${req.docId} –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ ${req.uid}`);
  }
  arr.splice(index,1);
  localStorage.setItem(DELETE_KEY, JSON.stringify(arr));
  renderDeletes();
  renderUsers();
  renderLogs();
}

/* ---------- Issue (create document) ---------- */
function genDocId(){
  const a = Math.floor(1000 + Math.random()*9000);
  const b = Math.floor(10 + Math.random()*90);
  const c = Math.floor(100 + Math.random()*900);
  return `DOC-${a}-${b}-${c}`;
}

function issueFromForm(){
  const uid = (document.getElementById('targetId').value || '').trim();
  const type = (document.getElementById('docType').value || '').trim();
  const source = (document.getElementById('docSource').value || '').trim() || '–¶–ù–ê–ü';
  const validUntil = document.getElementById('validUntil').value;
  const desc = document.getElementById('docDesc').value || '';
  const stampType = document.getElementById('stampType').value || 'circle';
  const signature = sigCanvas.toDataURL();

  if(!uid || !type || !validUntil) return alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å UID, —Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞ —ñ –¥–∞—Ç—É –¥—ñ–π—Å–Ω–æ—Å—Ç—ñ!');

  const db = JSON.parse(localStorage.getItem(DB_KEY)) || {};
  if(!db[uid]) db[uid] = [];

  const docId = genDocId();
  const doc = { docId, type, source, validUntil, desc, img: chosenImg, signature, stampType, createdAt: new Date().toISOString() };
  db[uid].push(doc);
  localStorage.setItem(DB_KEY, JSON.stringify(db));

  // logs
  pushLog(`–ê–¥–º—ñ–Ω –≤–∏–¥–∞–≤ ${type} –¥–ª—è ${uid} (${docId})`);

  // clear form
  document.getElementById('targetId').value='';
  document.getElementById('docType').value='';
  document.getElementById('docSource').value='';
  document.getElementById('validUntil').value='';
  document.getElementById('docDesc').value='';
  chosenImg = null; document.getElementById('thumb').style.display='none'; clearSignature();

  // redirect to document view
  window.location.href = `document.html?uid=${encodeURIComponent(uid)}&docId=${encodeURIComponent(docId)}`;
}

/* allow issuing via direct function name used in earlier code */
function issue(){ issueFromForm(); }

/* shortcut: fill with last document for quick edits */
function prefillFromCurrentDoc(){
  const db = JSON.parse(localStorage.getItem(DB_KEY)) || {};
  const uids = Object.keys(db);
  if(uids.length === 0) return alert('–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤, —â–æ–± –∑–∞–ø–æ–≤–Ω–∏—Ç–∏ –∑ –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ');
  // find most recent doc by createdAt
  let latest = null;
  let latestUid = null;
  for(const u of uids){
    for(const d of db[u]){
      if(!latest || (d.createdAt && d.createdAt > latest.createdAt)){ latest = d; latestUid = u; }
    }
  }
  if(!latest) return alert('–ù–µ–º–∞—î –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç—É');
  document.getElementById('targetId').value = latestUid;
  document.getElementById('docType').value = latest.type || '';
  document.getElementById('docSource').value = latest.source || '';
  document.getElementById('validUntil').value = latest.validUntil || '';
  document.getElementById('docDesc').value = latest.desc || '';
  document.getElementById('stampType').value = latest.stampType || 'circle';
  if(latest.img){ chosenImg = latest.img; const t = document.getElementById('thumb'); t.src = chosenImg; t.style.display='block'; } else { chosenImg = null; document.getElementById('thumb').style.display='none'; }
    // show preview that it's filled
  document.getElementById('issue-hint').innerText = `–ó–∞–ø–æ–≤–Ω–µ–Ω–æ –∑ ${latest.docId}`;
}

/* ---------- Apply-request integration ---------- */
/* When admin clicks "create" in requests, we call createFromRequest() above which fills the issue form.
   Optionally we can remove the request after issuing. Provide explicit function to accept request => create doc + remove request.
*/
function acceptRequestAndCreate(idx){
  const reqs = JSON.parse(localStorage.getItem(APPLY_KEY) || '[]');
  const r = reqs[idx];
  if(!r) return alert('–ó–∞–ø–∏—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∏–π');
  // prefill form and create document
  document.getElementById('targetId').value = r.id;
  document.getElementById('docType').value = r.title;
  document.getElementById('docSource').value = r.source || '';
  document.getElementById('validUntil').value = r.validUntil || '';
  document.getElementById('docDesc').value = r.desc || '';
  document.getElementById('stampType').value = r.stamp || 'circle';
  if(r.img){ chosenImg = r.img; const t = document.getElementById('thumb'); t.src = chosenImg; t.style.display='block'; } else { chosenImg = null; }
  clearSignature();
  // now issue
  issueFromForm();
  // remove request
  reqs.splice(idx,1);
  localStorage.setItem(APPLY_KEY, JSON.stringify(reqs));
  renderRequests();
}

/* ---------- Delete requests util for other pages ---------- */
function pushDeleteRequest(uid, docId){
  const arr = JSON.parse(localStorage.getItem(DELETE_KEY) || '[]');
  // prevent duplicates
  if(arr.find(r => r.uid === uid && r.docId === docId)) return;
  arr.push({ uid, docId, date: new Date().toLocaleString() });
  localStorage.setItem(DELETE_KEY, JSON.stringify(arr));
  pushLog(`–û—Ç—Ä–∏–º–∞–Ω–æ –∑–∞–ø–∏—Ç –Ω–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è ${docId} (${uid})`);
  renderDeletes();
}

/* ---------- Logs helper ---------- */
function pushLog(text){
  const logs = JSON.parse(localStorage.getItem(LOGS_KEY) || '[]');
  logs.unshift(`${new Date().toLocaleString()} ‚Äî ${text}`);
  // cap logs to 500 entries
  if(logs.length > 500) logs.length = 500;
  localStorage.setItem(LOGS_KEY, JSON.stringify(logs));
}

/* ---------- Utility: escape html ---------- */
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"'`]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;', '`':'&#96;' })[c]); }

/* ---------- Init ---------- */
(function initAdmin(){
  // cleanup
  cleanupEmptyDocumentsSave();
  renderRequests();
  renderUsers();
  renderLogs();
  renderDeletes();
  // admin name
  document.getElementById('admin-name').innerText = localStorage.getItem('userName') || 'Admin';
})();

/* Expose some functions for buttons bound in HTML (older code paths) */
window.createFromRequest = createFromRequest;
window.removeRequest = removeRequest;
window.previewRequest = previewRequest;
window.acceptRequestAndCreate = acceptRequestAndCreate;
window.issueFromForm = issueFromForm;
window.issue = issueFromForm;
window.pushDeleteRequest = pushDeleteRequest;
window.renderDeletes = renderDeletes;

</script>
</body>
</html>
