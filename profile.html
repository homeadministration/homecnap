<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Мої документи — ЦНАП</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f2f6fb;
  --card:#ffffff;
  --accent:#0052cc;
  --muted:#6b7280;
  --radius:18px;
  --glass: rgba(255,255,255,0.6);
}
*{box-sizing:border-box}
body{font-family:"Inter",system-ui,Segoe UI,Arial;background:linear-gradient(180deg,#eef6ff 0%, #f8fbff 100%);margin:0;color:#0f172a;-webkit-font-smoothing:antialiased}
header{
  position:sticky;top:0;background:rgba(255,255,255,0.6);backdrop-filter: blur(6px);
  border-bottom:1px solid rgba(15,23,42,0.06);padding:18px 6%;display:flex;align-items:center;justify-content:space-between;z-index:50;
}
.logo{font-weight:800;color:var(--accent);font-size:1.15rem}
.nav a{margin-left:18px;text-decoration:none;color:#0f172a;opacity:0.85;font-weight:600}
.container{max-width:1200px;margin:28px auto;padding:0 6%}
.hero{display:flex;align-items:center;justify-content:space-between;gap:20px;margin-bottom:20px}
.hero-left{display:flex;flex-direction:column;gap:6px}
.h1{font-size:1.6rem;font-weight:800;margin:0}
.hint{color:var(--muted);font-size:0.95rem}
.user-card{background:linear-gradient(180deg, rgba(255,255,255,0.8), rgba(255,255,255,0.7));border-radius:14px;padding:14px 18px;box-shadow:0 8px 30px rgba(2,6,23,0.04);display:flex;justify-content:space-between;align-items:center;border:1px solid rgba(2,6,23,0.05)}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:18px;margin-top:20px}
.card{background:linear-gradient(180deg, #ffffff, rgba(255,255,255,0.95));border-radius:14px;padding:16px;border:1px solid rgba(2,6,23,0.04);box-shadow:0 8px 24px rgba(2,6,23,0.03);cursor:pointer;transition:transform .18s ease, box-shadow .18s ease;min-height:120px;display:flex;flex-direction:column;justify-content:space-between}
.card:hover{transform:translateY(-6px);box-shadow:0 18px 40px rgba(2,6,23,0.06)}
.title{font-weight:700;font-size:1rem;color:#071133;text-align:left;word-break:break-word}
.meta{display:flex;gap:10px;align-items:center;margin-top:8px;flex-wrap:wrap}
.badge{padding:6px 10px;border-radius:10px;color:white;font-weight:700;font-size:.8rem}
.badge.valid{background:#16a34a}
.badge.invalid{background:#ef4444}
.small{font-size:0.85rem;color:var(--muted)}
.empty-note{padding:18px;background:var(--card);border-radius:12px;border:1px dashed rgba(2,6,23,0.04);text-align:center;color:var(--muted)}
.footer{margin-top:30px;color:var(--muted);font-size:0.85rem;text-align:center}

/* responsive */
@media(max-width:720px){
  .hero{flex-direction:column;align-items:flex-start}
}
</style>
</head>
<body>
<header>
  <div class="logo">ЦНАП.УКР</div>
  <nav class="nav">
    <a href="index.html">Головна</a>
    <a href="profile.html">Мої документи</a>
    <a href="admin.html" id="nav-admin" style="display:none">Адміністрування</a>
  </nav>
</header>

<div class="container">
  <div class="hero">
    <div class="hero-left">
      <div class="h1">Мої документи</div>
      <div class="hint">Зберігаються офіційні бланки, підписи та печатки. Натисни на документ щоб відкрити його.</div>
    </div>
    <div class="user-card">
      <div>
        <div style="font-size:0.85rem;color:var(--muted)">Вітаємо у кабінеті</div>
        <div style="font-weight:800;font-size:1.05rem" id="user-name">Громадянин</div>
      </div>
      <div style="text-align:right">
        <div style="font-size:0.75rem;color:var(--muted)">Ваш цифровий ID</div>
        <div style="font-family:monospace;font-weight:800;color:var(--accent)" id="user-id">UA-0000-00-000</div>
      </div>
    </div>
  </div>

  <div id="grid" class="grid"></div>

  <div class="footer">Якщо документ виявиться порожнім — він автоматично буде видалений.</div>
</div>

<script>
/* ---------- helper: remove empty documents across all users ----------
   Empty doc = no type && no desc && no img && no signature
---------------------------------------------------------------------*/
function cleanupEmptyDocsSave(){
  const db = JSON.parse(localStorage.getItem('gov_documents')) || {};
  let changed = false;
  for(const uid of Object.keys(db)){
    const before = db[uid];
    const after = before.filter(d => {
      const emptyType = !(d.type && d.type.toString().trim().length);
      const emptyDesc = !(d.desc && d.desc.toString().trim().length);
      const noImg = !d.img;
      const noSig = !d.signature || d.signature.length < 50;
      // consider empty only when all are empty
      return !(emptyType && emptyDesc && noImg && noSig);
    });
    if(after.length !== before.length){
      db[uid] = after;
      changed = true;
    }
    if(db[uid].length===0) delete db[uid];
  }
  if(changed) localStorage.setItem('gov_documents', JSON.stringify(db));
  return db;
}

/* ---------- render profile ----------
   - apply glass design
   - show only title + small meta
   - click -> document.html?uid=...&docId=...
------------------------------------------------------------------*/
(function init(){
  // show admin link if role
  if(localStorage.getItem('userRole') === 'highadmin'){
    document.getElementById('nav-admin').style.display = 'inline-block';
  }

  // cleanup any empty docs globally
  const dbAfter = cleanupEmptyDocsSave();

  // get current user id & name
  const uid = localStorage.getItem('currentUserID') || (function(){
    const gen = 'UA-'+Math.floor(1000+Math.random()*9000)+'-'+Math.floor(10+Math.random()*90)+'-'+Math.floor(100+Math.random()*900);
    localStorage.setItem('currentUserID', gen);
    return gen;
  })();
  const name = localStorage.getItem('userName') || 'Громадянин';
  document.getElementById('user-id').innerText = uid;
  document.getElementById('user-name').innerText = name;

  // load user's docs (after cleanup)
  const db = JSON.parse(localStorage.getItem('gov_documents')) || {};
  const docs = db[uid] || [];

  const grid = document.getElementById('grid');
  grid.innerHTML = '';

  if(docs.length === 0){
    grid.innerHTML = '<div class="empty-note">У вас ще немає документів.</div>';
    return;
  }

  docs.forEach(d => {
    const card = document.createElement('div'); card.className = 'card';
    const title = document.createElement('div'); title.className='title'; title.innerText = d.type || 'Документ';
    const meta = document.createElement('div'); meta.className='meta';
    // validUntil logic
    let valid = false;
    if(d.validUntil){
      const today = new Date(); today.setHours(0,0,0,0);
      const expiry = new Date(d.validUntil); expiry.setHours(0,0,0,0);
      valid = expiry >= today;
    }
    const badge = document.createElement('div'); badge.className = 'badge '+(valid ? 'valid' : 'invalid');
    badge.innerText = valid ? 'Дійсний' : 'Недійсний';
    meta.appendChild(badge);

    const smallFrom = document.createElement('div'); smallFrom.className='small'; smallFrom.innerText = 'Від: ' + (d.source || 'ЦНАП');
    const smallDate = document.createElement('div'); smallDate.className='small'; smallDate.innerText = 'Дійсний до: ' + (d.validUntil ? new Date(d.validUntil).toLocaleDateString('uk-UA') : '—');

    meta.appendChild(smallFrom);
    meta.appendChild(smallDate);

    card.appendChild(title);
    card.appendChild(meta);

    card.addEventListener('click', ()=> {
      // navigate to document - pass both uid and docId
      window.location.href = `document.html?uid=${encodeURIComponent(uid)}&docId=${encodeURIComponent(d.docId)}`;
    });

    grid.appendChild(card);
  });

})();
</script>
</body>
</html>
